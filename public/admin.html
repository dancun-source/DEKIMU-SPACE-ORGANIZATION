<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | DEKIMU SPACE PROGRAM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <a href="index.html"
                    style="display: flex; align-items: center; gap: 10px; color: white; text-decoration: none;">
                    <img src="DEKIMU LOGO.jpg.jpg" alt="Logo"
                        style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--secondary-color);">
                    DEKIMU <span>SPACE</span>
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html">Student View</a></li>
                <li><a href="#" onclick="logout()" class="btn btn-outline">Logout</a></li>
            </ul>
        </div>
    </nav>

    <section class="section-padding" style="min-height: 100vh; padding-top: 120px;">
        <div class="container">
            <div class="section-header">
                <h2>Mission Control</h2>
                <p>Upload Sessions & Manage Content</p>
            </div>

            <div id="admin-content" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                    <!-- Sidebar: Course List -->
                    <div class="step-card" style="padding: 20px;">
                        <h3
                            style="font-size: 1.5rem; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                            Select Course</h3>
                        <div id="course-list" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- Courses injected here -->
                        </div>
                    </div>

                    <!-- Main: Edit Area -->
                    <div id="edit-area" class="step-card">
                        <h3 id="selected-course-title" style="color: var(--secondary-color);">Select a course to edit
                        </h3>

                        <div id="edit-form-container" style="display: none; margin-top: 30px;">
                            <!-- Course Cover Photo Manager -->
                            <div
                                style="margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h4 style="margin-bottom: 15px; color: var(--text-main);">Course Cover Photo</h4>
                                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                                    <div style="width: 160px; height: 100px; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3);">
                                        <img id="course-thumbnail-preview" src="DEKIMU LOGO.jpg.jpg"
                                            alt="Course thumbnail"
                                            style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <div style="flex: 1; min-width: 200px;">
                                        <label for="thumbnail-file"
                                            style="display:block; margin-bottom:8px; color:var(--text-main);">Upload
                                            new photo</label>
                                        <input type="file" id="thumbnail-file" accept="*/*"
                                            style="margin-bottom:10px; color: var(--text-main);">
                                        <p id="thumbnail-status"
                                            style="font-size:0.9rem; color:var(--text-muted); margin:0;"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Course Content Manager -->
                            <form id="add-content-form" class="contact-form">
                                <h4 style="margin-bottom: 20px; color: var(--text-main);">
                                    Add New Content</h4>

                                <div class="form-group">
                                    <label>Content Type</label>
                                    <select id="content-type"
                                        style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); border-radius: 6px;">
                                        <option value="video" style="color: black;">Video Lesson</option>
                                        <option value="pdf" style="color: black;">PDF Note</option>
                                        <option value="live" style="color: black;">Live Session Link</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Title</label>
                                    <input type="text" id="content-title" placeholder="e.g., Week 1: Introduction"
                                        required>
                                </div>

                                <div class="form-group">
                                    <label>URL / Link</label>
                                    <input type="url" id="content-url" placeholder="https://..." required>
                                </div>

                                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Content</button>
                            </form>

                            <div style="margin-top: 50px;">
                                <h4
                                    style="margin-bottom: 20px; color: var(--text-main); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                                    Current Content</h4>
                                <div id="current-content-list"
                                    style="display: flex; flex-direction: column; gap: 15px;">
                                    <!-- Existing content items -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        let courses = [];
        let selectedCourse = null;

        // Auth Check: require login; backend still enforces admin-only actions
        if (!user || !user.token) {
            alert('Please login first to access Mission Control.');
            window.location.href = 'login.html';
        } else {
            document.getElementById('admin-content').style.display = 'block';
            fetchCourses();
        }

        async function fetchCourses() {
            try {
                const res = await fetch('/api/courses');
                courses = await res.json();
                renderCourseList();
            } catch (error) {
                console.error(error);
                alert('Failed to load courses');
            }
        }

        function renderCourseList() {
            const list = document.getElementById('course-list');
            list.innerHTML = courses.map(course => `
                <div onclick="selectCourse('${course._id}')" 
                     style="padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                     onmouseover="this.style.borderColor='var(--secondary-color)'"
                     onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'">
                    <strong style="color: var(--text-main);">${course.title}</strong>
                </div>
            `).join('');
        }

        function selectCourse(id) {
            selectedCourse = courses.find(c => c._id === id);
            document.getElementById('selected-course-title').textContent = `Editing: ${selectedCourse.title}`;
            document.getElementById('edit-form-container').style.display = 'block';

            // Update thumbnail preview
            const thumbImg = document.getElementById('course-thumbnail-preview');
            const statusEl = document.getElementById('thumbnail-status');
            if (thumbImg) {
                thumbImg.src = selectedCourse.thumbnail || 'DEKIMU LOGO.jpg.jpg';
            }
            if (statusEl) {
                statusEl.textContent = 'Current cover photo shown. Upload a new one to change it.';
            }

            renderCurrentContent();
        }

        function renderCurrentContent() {
            const list = document.getElementById('current-content-list');
            if (!selectedCourse.content || selectedCourse.content.length === 0) {
                list.innerHTML = '<p style="color: var(--text-muted);">No content uploaded yet.</p>';
                return;
            }

            list.innerHTML = selectedCourse.content.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <span style="font-size: 0.8rem; text-transform: uppercase; color: var(--secondary-color); font-weight: bold; margin-right: 10px;">${item.type}</span>
                        <span style="color: var(--text-main);">${item.title}</span>
                    </div>
                    <a href="${item.url}" target="_blank" style="color: var(--accent-blue);"><i class="fas fa-external-link-alt"></i></a>
                </div>
            `).join('');
        }

        document.getElementById('add-content-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const type = document.getElementById('content-type').value;
            const title = document.getElementById('content-title').value;
            const url = document.getElementById('content-url').value;

            const newContent = { type, title, url };

            // Add to local state
            if (!selectedCourse.content) selectedCourse.content = [];
            selectedCourse.content.push(newContent);

            try {
                const res = await fetch(`/api/courses/${selectedCourse._id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${user.token}`
                    },
                    body: JSON.stringify({ content: selectedCourse.content })
                });

                if (res.ok) {
                    alert('Content uploaded successfully!');
                    document.getElementById('add-content-form').reset();
                    renderCurrentContent();
                } else {
                    const data = await res.json();
                    alert(data.message || 'Failed to update course');
                }
            } catch (error) {
                console.error('Content update error:', error);
                const errorMsg = error.message || 'Failed to add content. Please try again.';
                alert(errorMsg);
            }
        });

        // Thumbnail upload handler
        const thumbnailInput = document.getElementById('thumbnail-file');
        if (thumbnailInput) {
            thumbnailInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                const statusEl = document.getElementById('thumbnail-status');
                const previewImg = document.getElementById('course-thumbnail-preview');

                if (!file) {
                    return;
                }

                if (!selectedCourse) {
                    alert('Please select a course first.');
                    thumbnailInput.value = '';
                    return;
                }

                if (statusEl) {
                    statusEl.style.color = 'var(--secondary-color)';
                    statusEl.textContent = 'Uploading photo...';
                }

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const uploadRes = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${user.token}`
                        },
                        body: formData
                    });

                    const uploadData = await uploadRes.json();

                    if (!uploadRes.ok) {
                        throw new Error(uploadData.message || 'Upload failed');
                    }

                    const uploadPath = uploadData.path;

                    // Save thumbnail URL on course
                    const updateRes = await fetch(`/api/courses/${selectedCourse._id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${user.token}`
                        },
                        body: JSON.stringify({ thumbnail: uploadPath })
                    });

                    const updatedCourse = await updateRes.json();

                    if (!updateRes.ok) {
                        throw new Error(updatedCourse.message || 'Failed to update course thumbnail');
                    }

                    selectedCourse.thumbnail = updatedCourse.thumbnail;
                    if (previewImg) {
                        previewImg.src = updatedCourse.thumbnail || 'DEKIMU LOGO.jpg.jpg';
                    }
                    if (statusEl) {
                        statusEl.style.color = '#64FFDA';
                        statusEl.textContent = 'Cover photo updated successfully.';
                    }

                    // Also refresh course list thumbnails in memory
                    courses = courses.map(c => c._id === updatedCourse._id ? updatedCourse : c);

                } catch (error) {
                    console.error('Upload error:', error);
                    if (statusEl) {
                        statusEl.style.color = '#FF6B6B';
                        const errorMsg = error.message || 'Failed to update cover photo.';
                        statusEl.textContent = errorMsg.includes('50MB') 
                            ? 'File too large. Maximum size is 50MB.' 
                            : errorMsg;
                    }
                    alert('Upload failed: ' + (error.message || 'Please try again.'));
                } finally {
                    thumbnailInput.value = '';
                }
            });
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>